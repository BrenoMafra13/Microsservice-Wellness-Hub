name: studentwellnesshub-integrated

networks:
  appnet:

volumes:
  pgdata:
  mongodata:

services:
  db:
    image: postgres:12-alpine
    container_name: pg-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 15
    networks: [appnet]

  redis:
    image: redis:7-alpine
    container_name: redis-cache
    command: ["redis-server","--appendonly","yes"]
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 5s
      timeout: 3s
      retries: 15
    networks: [appnet]

  mongo:
    image: mongo:6.0
    container_name: mongo-db
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongodata:/data/db
      - ./mongo/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${MONGO_PORT}:27017"
    healthcheck:
      test: ["CMD-SHELL", "mongosh --username ${MONGO_INITDB_ROOT_USERNAME} --password ${MONGO_INITDB_ROOT_PASSWORD} --eval 'db.runCommand({ ping: 1 })' --authenticationDatabase admin || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks: [appnet]

  mongo-express:
    image: mongo-express:1.0.2-20
    container_name: mongo-express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "8087:8081"
    networks: [appnet]

  wellness-resource-service:
    image: wellness-resource-service:local
    container_name: wellness-resource
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://${WELLNESS_DB_HOST}:${WELLNESS_DB_PORT}/${WELLNESS_DB}
      SPRING_DATASOURCE_USERNAME: ${WELLNESS_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${WELLNESS_DB_PASS}
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"

      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT}
      SPRING_CACHE_TYPE: redis

      SERVER_PORT: ${WELLNESS_PORT}
    ports:
      - "${WELLNESS_PORT}:${WELLNESS_PORT}"
    networks: [appnet]
    restart: unless-stopped

  event-service:
    image: event-service:local
    container_name: event-service
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://${EVENT_DB_HOST}:${EVENT_DB_PORT}/${EVENT_DB}
      SPRING_DATASOURCE_USERNAME: ${EVENT_DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${EVENT_DB_PASS}
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
      SERVER_PORT: ${EVENT_PORT}
    ports:
      - "${EVENT_PORT}:${EVENT_PORT}"
    networks: [appnet]
    restart: unless-stopped

  goal-tracking-service:
    image: goal-tracking-service:local
    container_name: goal-tracking
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      SPRING_DATA_MONGODB_URI: mongodb://${MONGO_APP_USER}:${MONGO_APP_PASS}@mongo:27017/${MONGO_INITDB_DATABASE}?authSource=admin
      SERVER_PORT: ${GOAL_PORT}
    ports:
      - "${GOAL_PORT}:${GOAL_PORT}"
    networks: [appnet]
    restart: unless-stopped
